<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>航空写真 輪郭・面積検索</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

<style>
  body { margin: 0; padding: 0; font-family: sans-serif; }
  #map { height: 100vh; width: 100vw; cursor: grab; }
  .ui-container { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: center; pointer-events: none; }
  .search-box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); text-align: center; pointer-events: auto; }
  #address-input { width: 250px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
  .button { padding: 8px 12px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; margin-left: 5px; }
  .button:hover { background-color: #0056b3; }
  .action-button { margin: 5px; }
  #suggestions { margin-top: 10px; max-height: 180px; overflow-y: auto; text-align: left; }
  .suggestion-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
  .suggestion-item:hover { background-color: #f0f0f0; }
  #crosshair { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px black; transform: translate(-50%, -50%); pointer-events: none; display: none; z-index: 999; }
  #crosshair::before, #crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 3px black; }
  #crosshair::before { top: 50%; left: 6px; right: 6px; height: 3px; margin-top: -1.5px; }
  #crosshair::after { left: 50%; top: 6px; bottom: 6px; width: 3px; margin-left: -1.5px; }
  #info-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; z-index: 1000; display: none; }
  #calculator-container { position: absolute; bottom: 10px; left: 10px; width: 240px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; display: none; pointer-events: auto; }
  #calculator-header { padding: 10px; background-color: #f7f7f7; border-bottom: 1px solid #eee; border-top-left-radius: 8px; border-top-right-radius: 8px; }
  #calculator-header h3 { margin: 0; font-size: 16px; }
  #calculator-list { list-style-type: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; }
  #calculator-list li { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; }
  #calculator-footer { padding: 10px; background-color: #f0f0f0; font-weight: bold; }
  #roof-calculator { padding: 10px; border-top: 2px solid #ddd; background-color: #f0f0f0; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
  #roof-calculator div { margin-top: 8px; }
  #roof-area-total { font-weight: bold; color: #007bff; }
</style>
</head>
<body>

<div class="ui-container">
  <div class="search-box">
    <div>
      <input type="text" id="address-input" placeholder="住所を入力して検索">
      <button id="search-button" class="button">検索</button>
    </div>
    <div id="suggestions"></div>
    <div id="action-buttons" style="margin-top: 10px;"></div>
  </div>
</div>

<div id="calculator-container">
  <div id="calculator-header"><h3>面積計算</h3></div>
  <ul id="calculator-list"></ul>
  <div id="calculator-footer">Footprint合計: 0 m²</div>
  <div id="roof-calculator">
    <div>
      <label for="slope-rate-select" style="font-size: 14px;">勾配伸び率:</label>
      <select id="slope-rate-select" style="padding: 4px; border-radius: 4px;">
        <option value="1.000">1.000 (陸屋根)</option>
        <option value="1.001">1.001 (5分)</option>
        <option value="1.005">1.005 (1寸)</option>
        <option value="1.011">1.011 (1寸5分)</option>
        <option value="1.020">1.020 (2寸)</option>
        <option value="1.031">1.031 (2寸5分)</option>
        <option value="1.044">1.044 (3寸)</option>
        <option value="1.050">1.050 (3寸5分)</option>
        <option value="1.077" selected>1.077 (4寸)</option>
        <option value="1.097">1.097 (4寸5分)</option>
        <option value="1.118">1.118 (5寸)</option>
        <option value="1.141">1.141 (5寸5分)</option>
        <option value="1.166">1.166 (6寸)</option>
        <option value="1.193">1.193 (6寸5分)</option>
        <option value="1.221">1.221 (7寸)</option>
        <option value="1.250">1.250 (7寸5分)</option>
        <option value="1.281">1.281 (8寸)</option>
        <option value="1.312">1.312 (8寸5分)</option>
        <option value="1.345">1.345 (9寸)</option>
        <option value="1.379">1.379 (9寸5分)</option>
        <option value="1.414">1.414 (矩勾配)</option>
        <option value="1.487">1.487 (9寸返し)</option>
        <option value="1.562">1.562 (8寸返し)</option>
      </select>
    </div>
    <div id="roof-area-total">屋根面積合計: 0 m²</div>
  </div>
</div>

<div id="crosshair"></div>
<div id="info-box"></div>
<div id="map"></div>

<script>
  let activeLayer, currentInfo = { lat: 0, lng: 0, title: '' };
  let selectedLayers = {};

  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 15);
  const addressInput = document.getElementById('address-input');
  const searchButton = document.getElementById('search-button');
  const suggestionsContainer = document.getElementById('suggestions');
  const actionButtonsContainer = document.getElementById('action-buttons');
  const crosshair = document.getElementById('crosshair');
  const infoBox = document.getElementById('info-box');
  const calculatorContainer = document.getElementById('calculator-container');
  const calculatorList = document.getElementById('calculator-list');
  const footprintTotalFooter = document.getElementById('calculator-footer');
  const slopeRateSelect = document.getElementById('slope-rate-select');
  const roofAreaTotalDiv = document.getElementById('roof-area-total');

  L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', { attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>|© <a href='https://www.openstreetmap.org/copyright'>OSM</a> contributors", maxNativeZoom: 18, maxZoom: 21 }).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  searchButton.addEventListener('click', handleSearch);
  addressInput.addEventListener('keypress', e => e.key === 'Enter' && handleSearch());
  slopeRateSelect.addEventListener('change', updateCalculator);

  async function fetchWithTimeout(resource, options = {}, timeout = 15000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    const response = await fetch(resource, { ...options, signal: controller.signal });
    clearTimeout(id);
    return response;
  }

  function updateUI(mode) {
    crosshair.style.display = 'none';
    actionButtonsContainer.innerHTML = '';
    infoBox.style.display = 'none';
    if (mode !== 'polygon_displayed') calculatorContainer.style.display = 'none';

    if (mode === 'adjust') {
      crosshair.style.display = 'block';
      infoBox.textContent = '十字の中心を建物に合わせ、ボタンを押してください';
      infoBox.style.display = 'block';
      const multiBtn = document.createElement('button');
      multiBtn.className = 'button action-button';
      multiBtn.textContent = '周辺50mの輪郭を取得';
      multiBtn.onclick = () => handlePolygonFetch(true);
      actionButtonsContainer.appendChild(multiBtn);
    } else if (mode === 'polygon_displayed') {
      infoBox.textContent = '輪郭が違う場合は再調整できます。周辺検索時は輪郭クリックで面積計算できます。';
      infoBox.style.display = 'block';
      const retryBtn = document.createElement('button');
      retryBtn.className = 'button';
      retryBtn.textContent = '位置を再調整する';
      retryBtn.onclick = enterAdjustmentModeFromCurrentView;
      actionButtonsContainer.appendChild(retryBtn);
    }
  }

  function clearActiveLayer() { if (activeLayer) map.removeLayer(activeLayer); activeLayer = null; }

  function enterAdjustmentModeFromCurrentView() { clearActiveLayer(); updateUI('adjust'); }

  function setupAdjustmentMode(lat, lng, title) {
    clearActiveLayer();
    suggestionsContainer.innerHTML = '';
    currentInfo = { lat, lng, title };
    map.setView([lat, lng], 19);
    updateUI('adjust');
  }

  async function handlePolygonFetch(fetchAll = false) {
    const center = map.getCenter();
    currentInfo.lat = center.lat; currentInfo.lng = center.lng;
    updateUI('fetching');
    infoBox.textContent = '輪郭データを検索中...';
    infoBox.style.display = 'block';
    try {
      const buildings = await fetchBuildingPolygons(center.lat, center.lng);
      clearActiveLayer();
      if (!buildings || buildings.length === 0) throw new Error('この場所の建物の輪郭データは見つかりませんでした。');

      if (fetchAll) {
        const layers = buildings.map(b => createPolygonLayer(b)).filter(l => l !== null);
        if (layers.length > 0) {
          activeLayer = L.featureGroup(layers).addTo(map);
          map.fitBounds(activeLayer.getBounds(), { padding: [50, 50] });
          calculatorContainer.style.display = 'block';
          resetCalculator();
        } else { throw new Error('有効な輪郭データが見つかりませんでした。'); }
      } else {
        let closestBuilding = findClosestBuilding(center, buildings);
        if (closestBuilding) {
          activeLayer = createPolygonLayer(closestBuilding, currentInfo.title);
          if (activeLayer) { activeLayer.addTo(map); map.fitBounds(activeLayer.getBounds(), { padding: [50, 50] }); }
           else { throw new Error('有効な輪郭データが見つかりませんでした。'); }
        } else { throw new Error('最も近い建物が見つかりませんでした。'); }
      }
      updateUI('polygon_displayed');
    } catch (error) {
      alert(error.name === 'AbortError' ? '検索がタイムアウトしました。' : error.message);
      setupAdjustmentMode(center.lat, center.lng, currentInfo.title);
    }
  }
  
  function createPolygonLayer(building, title = '') {
    const geom = building.geometry;
    if (!geom || geom.length < 3) return null;
    const polygonCoords = geom.map(node => [node.lon, node.lat]);
    if (polygonCoords[0][0] !== polygonCoords[polygonCoords.length - 1][0] || polygonCoords[0][1] !== polygonCoords[polygonCoords.length - 1][1]) {
        polygonCoords.push(polygonCoords[0]);
    }
    const turfPolygon = turf.polygon([polygonCoords]);
    const area = turf.area(turfPolygon);
    const areaString = `<b>面積: ${Math.round(area)} m²</b>`;
    const leafletCoords = polygonCoords.map(p => [p[1], p[0]]);
    const layer = L.polygon(leafletCoords, { color: '#3388ff' });
    layer.feature = { properties: { area: Math.round(area), id: building.id, originalCoords: leafletCoords } };
    layer.bindPopup(title ? `${title}<br>${areaString}` : areaString);
    layer.on('click', toggleSelection);
    return layer;
  }

  function toggleSelection(e) {
    const layer = e.target;
    const id = layer.feature.properties.id;
    if (selectedLayers.hasOwnProperty(id)) {
      delete selectedLayers[id];
      layer.setStyle({ color: '#3388ff' });
    } else {
      selectedLayers[id] = layer.feature.properties;
      layer.setStyle({ color: 'yellow' });
    }
    updateCalculator();
  }

  function resetCalculator() {
    selectedLayers = {};
    updateCalculator();
  }

  function updateCalculator() {
    calculatorList.innerHTML = '';
    let totalFootprintArea = 0;
    for (const id in selectedLayers) {
      const props = selectedLayers[id];
      const li = document.createElement('li');
      li.innerHTML = `<span>ID ${id}</span><span>${props.area} m²</span>`;
      calculatorList.appendChild(li);
      totalFootprintArea += props.area;
    }
    const slopeRate = parseFloat(slopeRateSelect.value);
    const totalRoofArea = totalFootprintArea * slopeRate;
    footprintTotalFooter.textContent = `Footprint合計: ${totalFootprintArea} m²`;
    roofAreaTotalDiv.textContent = `屋根面積合計: ${Math.round(totalRoofArea)} m²`;
  }

  function findClosestBuilding(center, buildings) {
    let minDistance = Infinity, closestBuilding = null;
    const centerPoint = turf.point([center.lng, center.lat]);
    buildings.forEach(building => {
      const geom = building.geometry;
      if (!geom || geom.length < 3) return;
      const polygonCoords = geom.map(node => [node.lon, node.lat]);
      if (polygonCoords[0][0] !== polygonCoords[polygonCoords.length - 1][0] || polygonCoords[0][1] !== polygonCoords[polygonCoords.length - 1][1]) {
          polygonCoords.push(polygonCoords[0]);
      }
      const turfPolygon = turf.polygon([polygonCoords]);
      const centroid = turf.centroid(turfPolygon);
      const distance = turf.distance(centerPoint, centroid, {units: 'meters'});
      if (distance < minDistance) { minDistance = distance; closestBuilding = building; }
    });
    return closestBuilding;
  }

  async function fetchBuildingPolygons(lat, lon) {
    const radius = 50;
    const overpassUrl = 'https://overpass-api.de/api/interpreter';
    const query = `[out:json][timeout:15];way(around:${radius},${lat},${lon})["building"];out geom;`;
    const response = await fetchWithTimeout(overpassUrl, { method: 'POST', body: query });
    if (!response.ok) { throw new Error(`サーバー応答エラー: ${response.status}`); }
    const data = await response.json();
    return data.elements.filter(e => e.type === 'way' && e.geometry);
  }

  function displaySuggestions(results) {
    suggestionsContainer.innerHTML = '';
    const header = document.createElement('div');
    header.innerHTML = '<b>こちらの住所でしょうか？</b>';
    suggestionsContainer.appendChild(header);
    results.forEach(result => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.textContent = result.properties.title;
      item.onclick = () => {
        const coords = result.geometry.coordinates;
        setupAdjustmentMode(coords[1], coords[0], result.properties.title);
      };
      suggestionsContainer.appendChild(item);
    });
  }

  async function handleSearch() {
    const address = addressInput.value;
    if (!address) { alert('住所を入力してください。'); return; }
    suggestionsContainer.innerHTML = '検索中...';
    actionButtonsContainer.innerHTML = '';
    try {
      const gsiApiUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;
      const response = await fetchWithTimeout(gsiApiUrl);
      if (response.ok) {
        const data = await response.json();
        if (data.length > 0) { displaySuggestions(data); return; }
      }
      suggestionsContainer.innerHTML = '';
      alert('指定された住所が見つかりませんでした。');
    } catch (error) {
      suggestionsContainer.innerHTML = '';
      alert(error.name === 'AbortError' ? '住所検索がタイムアウトしました。' : `住所検索エラー: ${error.message}`);
    }
  }
</script>

</body>
</html>