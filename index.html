<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>èˆªç©ºå†™çœŸ è¼ªéƒ­ãƒ»é¢ç©æ¤œç´¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
<style>
  * { box-sizing: border-box; }
  body { margin: 0; padding: 0; font-family: sans-serif; }
  #map { height: 100dvh; width: 100vw; cursor: grab; }

  .ui-container {
    position: absolute; top: 10px; left: 10px; right: 10px;
    z-index: 1000; display: flex; justify-content: center; pointer-events: none;
  }
  .search-box {
    background: white; padding: 10px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); text-align: center;
    pointer-events: auto; width: 100%; max-width: 420px;
  }
  .search-row { display: flex; gap: 6px; }
  #address-input {
    flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
    font-size: 16px; min-width: 0;
  }
  .button {
    padding: 10px 14px; border: none; background-color: #007bff;
    color: white; border-radius: 4px; cursor: pointer;
    font-size: 15px; white-space: nowrap; flex-shrink: 0;
  }
  .button:active { opacity: 0.8; }
  .button:hover { background-color: #0056b3; }
  .action-button { margin: 5px; }
  #suggestions { margin-top: 8px; max-height: 180px; overflow-y: auto; text-align: left; }
  .suggestion-item {
    padding: 10px 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px;
  }
  .suggestion-item:active { background-color: #e0e0e0; }
  .suggestion-item:hover { background-color: #f0f0f0; }
  #action-buttons { margin-top: 8px; display: flex; flex-wrap: wrap; justify-content: center; }

  /* info-boxã‚’æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç›´ä¸‹ã«è¡¨ç¤º */
  #info-box {
    margin-top: 8px;
    background: rgba(0,0,0,0.7); color: white; padding: 7px 12px;
    border-radius: 6px; display: none;
    font-size: 13px; line-height: 1.5; text-align: center;
  }

  /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
  #locate-button {
    position: absolute; bottom: 100px; right: 10px;
    z-index: 1000; width: 44px; height: 44px;
    background: white; border: 2px solid rgba(0,0,0,0.2);
    border-radius: 4px; cursor: pointer; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 5px rgba(0,0,0,0.3);
  }
  #locate-button:active { background: #f0f0f0; }

  #crosshair {
    position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
    border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px black;
    transform: translate(-50%, -50%); pointer-events: none; display: none; z-index: 999;
  }
  #crosshair::before, #crosshair::after {
    content: ''; position: absolute; background: white; box-shadow: 0 0 3px black;
  }
  #crosshair::before { top: 50%; left: 6px; right: 6px; height: 3px; margin-top: -1.5px; }
  #crosshair::after { left: 50%; top: 6px; bottom: 6px; width: 3px; margin-left: -1.5px; }

  #calculator-container {
    position: absolute; bottom: 10px; left: 10px; width: 240px;
    background: white; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; display: none; pointer-events: auto;
  }
  #calculator-header {
    padding: 10px; background-color: #f7f7f7; border-bottom: 1px solid #eee;
    border-top-left-radius: 8px; border-top-right-radius: 8px;
    display: flex; justify-content: space-between; align-items: center; gap: 6px;
  }
  #calculator-header h3 { margin: 0; font-size: 16px; flex: 1; }
  #calculator-list {
    list-style-type: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto;
  }
  #calculator-list li {
    padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 14px;
    display: flex; justify-content: space-between;
  }
  #calculator-footer { padding: 10px; background-color: #f0f0f0; font-weight: bold; font-size: 14px; }
  #roof-calculator {
    padding: 10px; border-top: 2px solid #ddd; background-color: #f0f0f0;
    border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
  }
  #roof-calculator div { margin-top: 8px; }
  #roof-area-total { font-weight: bold; color: #007bff; font-size: 14px; }

  .small-btn {
    padding: 4px 8px; font-size: 12px; border: none;
    border-radius: 4px; cursor: pointer; color: white;
  }
  .small-btn:active { opacity: 0.7; }
  #copy-btn { background: #555; }
  #reset-btn { background: #e74c3c; }

  @media (max-width: 400px) {
    #calculator-container { width: calc(100vw - 20px); left: 10px; right: 10px; }
  }
</style>
</head>
<body>

<div class="ui-container">
  <div class="search-box">
    <div class="search-row">
      <input type="text" id="address-input" placeholder="ä½æ‰€ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢" autocomplete="off">
      <button id="search-button" class="button">æ¤œç´¢</button>
    </div>
    <div id="suggestions"></div>
    <div id="action-buttons"></div>
    <!-- info-boxã‚’æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹å†…ã®ä¸€ç•ªä¸‹ã«é…ç½® -->
    <div id="info-box"></div>
  </div>
</div>

<button id="locate-button" title="ç¾åœ¨åœ°ã¸">ğŸ“</button>

<div id="calculator-container">
  <div id="calculator-header">
    <h3>é¢ç©è¨ˆç®—</h3>
    <button id="reset-btn" class="small-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="copy-btn" class="small-btn">ã‚³ãƒ”ãƒ¼</button>
  </div>
  <ul id="calculator-list"></ul>
  <div id="calculator-footer">Footprintåˆè¨ˆ: 0 mÂ²</div>
  <div id="roof-calculator">
    <div>
      <label for="slope-rate-select" style="font-size: 14px;">å‹¾é…ä¼¸ã³ç‡:</label>
      <select id="slope-rate-select" style="padding: 4px; border-radius: 4px; font-size: 14px;">
        <option value="1.000">1.000 (é™¸å±‹æ ¹)</option>
        <option value="1.001">1.001 (5åˆ†)</option>
        <option value="1.005">1.005 (1å¯¸)</option>
        <option value="1.011">1.011 (1å¯¸5åˆ†)</option>
        <option value="1.020">1.020 (2å¯¸)</option>
        <option value="1.031">1.031 (2å¯¸5åˆ†)</option>
        <option value="1.044">1.044 (3å¯¸)</option>
        <option value="1.050">1.050 (3å¯¸5åˆ†)</option>
        <option value="1.077" selected>1.077 (4å¯¸)</option>
        <option value="1.097">1.097 (4å¯¸5åˆ†)</option>
        <option value="1.118">1.118 (5å¯¸)</option>
        <option value="1.141">1.141 (5å¯¸5åˆ†)</option>
        <option value="1.166">1.166 (6å¯¸)</option>
        <option value="1.193">1.193 (6å¯¸5åˆ†)</option>
        <option value="1.221">1.221 (7å¯¸)</option>
        <option value="1.250">1.250 (7å¯¸5åˆ†)</option>
        <option value="1.281">1.281 (8å¯¸)</option>
        <option value="1.312">1.312 (8å¯¸5åˆ†)</option>
        <option value="1.345">1.345 (9å¯¸)</option>
        <option value="1.379">1.379 (9å¯¸5åˆ†)</option>
        <option value="1.414">1.414 (çŸ©å‹¾é…)</option>
        <option value="1.487">1.487 (9å¯¸è¿”ã—)</option>
        <option value="1.562">1.562 (8å¯¸è¿”ã—)</option>
      </select>
    </div>
    <div id="roof-area-total">å±‹æ ¹é¢ç©åˆè¨ˆ: 0 mÂ²</div>
  </div>
</div>

<div id="crosshair"></div>
<div id="map"></div>

<script>
  let activeLayer, currentInfo = { lat: 0, lng: 0, title: '' };
  let selectedLayers = {};

  const map = L.map('map', { zoomControl: false }).setView([35.681, 139.767], 15);
  const addressInput = document.getElementById('address-input');
  const searchButton = document.getElementById('search-button');
  const suggestionsContainer = document.getElementById('suggestions');
  const actionButtonsContainer = document.getElementById('action-buttons');
  const crosshair = document.getElementById('crosshair');
  const infoBox = document.getElementById('info-box');
  const calculatorContainer = document.getElementById('calculator-container');
  const calculatorList = document.getElementById('calculator-list');
  const footprintTotalFooter = document.getElementById('calculator-footer');
  const slopeRateSelect = document.getElementById('slope-rate-select');
  const roofAreaTotalDiv = document.getElementById('roof-area-total');
  const locateButton = document.getElementById('locate-button');
  const copyBtn = document.getElementById('copy-btn');
  const resetBtn = document.getElementById('reset-btn');

  L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>|Â© <a href='https://www.openstreetmap.org/copyright'>OSM</a> contributors",
    maxNativeZoom: 18, maxZoom: 21
  }).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
  locateButton.addEventListener('click', () => {
    if (!navigator.geolocation) { alert('ã“ã®ç«¯æœ«ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
    locateButton.textContent = 'â³';
    navigator.geolocation.getCurrentPosition(
      pos => {
        locateButton.textContent = 'ğŸ“';
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 19);
        setupAdjustmentMode(latitude, longitude, 'ç¾åœ¨åœ°');
      },
      err => {
        locateButton.textContent = 'ğŸ“';
        if (err.code === 1) alert('ä½ç½®æƒ…å ±ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\niPhoneã®å ´åˆï¼šè¨­å®š â†’ Safari â†’ ä½ç½®æƒ…å ± â†’ è¨±å¯');
        else alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
  copyBtn.addEventListener('click', () => {
    const footprint = footprintTotalFooter.textContent;
    const roof = roofAreaTotalDiv.textContent;
    const slope = slopeRateSelect.options[slopeRateSelect.selectedIndex].text;
    const text = `ã€å±‹æ ¹é¢ç©è¨ˆç®—ã€‘\n${footprint}\nå‹¾é…: ${slope}\n${roof}`;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = 'âœ“';
        setTimeout(() => copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼', 2000);
      });
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyBtn.textContent = 'âœ“';
      setTimeout(() => copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼', 2000);
    }
  });

  // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
  resetBtn.addEventListener('click', () => {
    // é¸æŠä¸­ã®è¼ªéƒ­ã®è‰²ã‚’å…ƒã«æˆ»ã™
    if (activeLayer) {
      activeLayer.eachLayer(layer => {
        if (layer.setStyle) layer.setStyle({ color: '#3388ff' });
      });
    }
    resetCalculator();
  });

  searchButton.addEventListener('click', () => { addressInput.blur(); handleSearch(); });
  addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') { addressInput.blur(); handleSearch(); } });
  slopeRateSelect.addEventListener('change', updateCalculator);

  async function fetchWithTimeout(resource, options = {}, timeout = 15000) {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    const response = await fetch(resource, { ...options, signal: controller.signal });
    clearTimeout(id);
    return response;
  }

  function updateUI(mode) {
    crosshair.style.display = 'none';
    actionButtonsContainer.innerHTML = '';
    infoBox.style.display = 'none';
    if (mode !== 'polygon_displayed') calculatorContainer.style.display = 'none';

    if (mode === 'adjust') {
      crosshair.style.display = 'block';
      infoBox.textContent = 'åå­—ã®ä¸­å¿ƒã‚’å»ºç‰©ã«åˆã‚ã›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
      infoBox.style.display = 'block';
      const multiBtn = document.createElement('button');
      multiBtn.className = 'button action-button';
      multiBtn.textContent = 'å‘¨è¾º50mã®è¼ªéƒ­ã‚’å–å¾—';
      multiBtn.onclick = () => handlePolygonFetch(true);
      actionButtonsContainer.appendChild(multiBtn);
    } else if (mode === 'polygon_displayed') {
      infoBox.textContent = 'è¼ªéƒ­ãŒé•ã†å ´åˆã¯å†èª¿æ•´ã§ãã¾ã™ã€‚å‘¨è¾ºæ¤œç´¢æ™‚ã¯è¼ªéƒ­ã‚¯ãƒªãƒƒã‚¯ã§é¢ç©è¨ˆç®—ã§ãã¾ã™ã€‚';
      infoBox.style.display = 'block';
      const retryBtn = document.createElement('button');
      retryBtn.className = 'button';
      retryBtn.style.fontSize = '14px';
      retryBtn.textContent = 'ä½ç½®ã‚’å†èª¿æ•´ã™ã‚‹';
      retryBtn.onclick = enterAdjustmentModeFromCurrentView;
      actionButtonsContainer.appendChild(retryBtn);
    }
  }

  function clearActiveLayer() { if (activeLayer) map.removeLayer(activeLayer); activeLayer = null; }
  function enterAdjustmentModeFromCurrentView() { clearActiveLayer(); updateUI('adjust'); }

  function setupAdjustmentMode(lat, lng, title) {
    clearActiveLayer();
    suggestionsContainer.innerHTML = '';
    currentInfo = { lat, lng, title };
    map.setView([lat, lng], 19);
    updateUI('adjust');
  }

  async function handlePolygonFetch(fetchAll = false) {
    const center = map.getCenter();
    currentInfo.lat = center.lat; currentInfo.lng = center.lng;
    updateUI('fetching');
    infoBox.textContent = 'è¼ªéƒ­ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...';
    infoBox.style.display = 'block';
    try {
      const buildings = await fetchBuildingPolygons(center.lat, center.lng);
      clearActiveLayer();
      if (!buildings || buildings.length === 0) throw new Error('ã“ã®å ´æ‰€ã®å»ºç‰©ã®è¼ªéƒ­ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');

      if (fetchAll) {
        const layers = buildings.map(b => createPolygonLayer(b)).filter(l => l !== null);
        if (layers.length > 0) {
          activeLayer = L.featureGroup(layers).addTo(map);
          map.fitBounds(activeLayer.getBounds(), { padding: [50, 50] });
          calculatorContainer.style.display = 'block';
          resetCalculator();
        } else { throw new Error('æœ‰åŠ¹ãªè¼ªéƒ­ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
      } else {
        let closestBuilding = findClosestBuilding(center, buildings);
        if (closestBuilding) {
          activeLayer = createPolygonLayer(closestBuilding, currentInfo.title);
          if (activeLayer) { activeLayer.addTo(map); map.fitBounds(activeLayer.getBounds(), { padding: [50, 50] }); }
          else { throw new Error('æœ‰åŠ¹ãªè¼ªéƒ­ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
        } else { throw new Error('æœ€ã‚‚è¿‘ã„å»ºç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
      }
      updateUI('polygon_displayed');
    } catch (error) {
      alert(error.name === 'AbortError' ? 'æ¤œç´¢ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚' : error.message);
      setupAdjustmentMode(center.lat, center.lng, currentInfo.title);
    }
  }

  function createPolygonLayer(building, title = '') {
    const geom = building.geometry;
    if (!geom || geom.length < 3) return null;
    const polygonCoords = geom.map(node => [node.lon, node.lat]);
    if (polygonCoords[0][0] !== polygonCoords[polygonCoords.length - 1][0] ||
        polygonCoords[0][1] !== polygonCoords[polygonCoords.length - 1][1]) {
      polygonCoords.push(polygonCoords[0]);
    }
    const turfPolygon = turf.polygon([polygonCoords]);
    const area = turf.area(turfPolygon);
    const areaString = `<b>é¢ç©: ${Math.round(area)} mÂ²</b>`;
    const leafletCoords = polygonCoords.map(p => [p[1], p[0]]);
    const layer = L.polygon(leafletCoords, { color: '#3388ff' });
    layer.feature = { properties: { area: Math.round(area), id: building.id, originalCoords: leafletCoords } };
    layer.bindPopup(title ? `${title}<br>${areaString}` : areaString);
    layer.on('click', toggleSelection);
    return layer;
  }

  function toggleSelection(e) {
    const layer = e.target;
    const id = layer.feature.properties.id;
    if (selectedLayers.hasOwnProperty(id)) {
      delete selectedLayers[id];
      layer.setStyle({ color: '#3388ff' });
    } else {
      selectedLayers[id] = layer.feature.properties;
      layer.setStyle({ color: 'yellow' });
    }
    updateCalculator();
  }

  function resetCalculator() {
    selectedLayers = {};
    updateCalculator();
  }

  function updateCalculator() {
    calculatorList.innerHTML = '';
    let totalFootprintArea = 0;
    for (const id in selectedLayers) {
      const props = selectedLayers[id];
      const li = document.createElement('li');
      li.innerHTML = `<span>ID ${id}</span><span>${props.area} mÂ²</span>`;
      calculatorList.appendChild(li);
      totalFootprintArea += props.area;
    }
    const slopeRate = parseFloat(slopeRateSelect.value);
    const totalRoofArea = totalFootprintArea * slopeRate;
    footprintTotalFooter.textContent = `Footprintåˆè¨ˆ: ${totalFootprintArea} mÂ²`;
    roofAreaTotalDiv.textContent = `å±‹æ ¹é¢ç©åˆè¨ˆ: ${Math.round(totalRoofArea)} mÂ²`;
  }

  function findClosestBuilding(center, buildings) {
    let minDistance = Infinity, closestBuilding = null;
    const centerPoint = turf.point([center.lng, center.lat]);
    buildings.forEach(building => {
      const geom = building.geometry;
      if (!geom || geom.length < 3) return;
      const polygonCoords = geom.map(node => [node.lon, node.lat]);
      if (polygonCoords[0][0] !== polygonCoords[polygonCoords.length - 1][0] ||
          polygonCoords[0][1] !== polygonCoords[polygonCoords.length - 1][1]) {
        polygonCoords.push(polygonCoords[0]);
      }
      const turfPolygon = turf.polygon([polygonCoords]);
      const centroid = turf.centroid(turfPolygon);
      const distance = turf.distance(centerPoint, centroid, { units: 'meters' });
      if (distance < minDistance) { minDistance = distance; closestBuilding = building; }
    });
    return closestBuilding;
  }

  async function fetchBuildingPolygons(lat, lon) {
    const radius = 50;
    const overpassUrl = 'https://overpass-api.de/api/interpreter';
    const query = `[out:json][timeout:15];way(around:${radius},${lat},${lon})["building"];out geom;`;
    const response = await fetchWithTimeout(overpassUrl, { method: 'POST', body: query });
    if (!response.ok) throw new Error(`ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    const data = await response.json();
    return data.elements.filter(e => e.type === 'way' && e.geometry);
  }

  function displaySuggestions(results) {
    suggestionsContainer.innerHTML = '';
    const header = document.createElement('div');
    header.style.padding = '4px 0';
    header.innerHTML = '<b>ã“ã¡ã‚‰ã®ä½æ‰€ã§ã—ã‚‡ã†ã‹ï¼Ÿ</b>';
    suggestionsContainer.appendChild(header);
    results.forEach(result => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.textContent = result.properties.title;
      item.onclick = () => {
        const coords = result.geometry.coordinates;
        addressInput.blur();
        setupAdjustmentMode(coords[1], coords[0], result.properties.title);
      };
      suggestionsContainer.appendChild(item);
    });
  }

  async function handleSearch() {
    const address = addressInput.value;
    if (!address) { alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    suggestionsContainer.innerHTML = 'æ¤œç´¢ä¸­...';
    actionButtonsContainer.innerHTML = '';
    try {
      const gsiApiUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;
      const response = await fetchWithTimeout(gsiApiUrl);
      if (response.ok) {
        const data = await response.json();
        if (data.length > 0) { displaySuggestions(data); return; }
      }
      suggestionsContainer.innerHTML = '';
      alert('æŒ‡å®šã•ã‚ŒãŸä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
    } catch (error) {
      suggestionsContainer.innerHTML = '';
      alert(error.name === 'AbortError' ? 'ä½æ‰€æ¤œç´¢ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚' : `ä½æ‰€æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
  }
</script>
</body>
</html>
